<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی چیستان با ربات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #0A0A0A; /* مشکی تیره‌تر */
            color: #E0E0E0;
        }
        .golden-gradient {
            background: linear-gradient(90deg, #FAD961, #F79521);
            transition: all 0.3s ease-in-out;
        }
        .golden-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(250, 217, 97, 0.4);
        }
        .golden-glow {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .text-golden {
            color: #F7D344;
        }
        .profile-card {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #333;
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .profile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        .button {
            border-radius: 9999px;
            padding: 12px 24px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button:active {
            transform: scale(0.95);
        }
        .navbar-icon {
            filter: grayscale(100%);
        }
        .active-navbar-icon {
            filter: grayscale(0%);
        }
        .countdown-text {
            font-variant-numeric: tabular-nums;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #1a1a1a;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            width: 90%;
            max-width: 450px;
            animation: fadeInScale 0.3s ease-out;
            box-shadow: 0 0 30px rgba(250, 217, 97, 0.4);
        }
        .main-menu-bg {
            background: radial-gradient(circle at top, rgba(255, 215, 0, 0.08) 0%, rgba(18, 18, 18, 0) 60%),
                        repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0.05) 0px, rgba(255, 255, 255, 0.05) 1px, transparent 1px, transparent 5px);
        }

        /* انیمیشن برای ذره‌بین در صفحه جستجو */
        @keyframes pulse-rotate {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(15deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .magnifying-glass-animated {
            animation: pulse-rotate 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* انیمیشن برای ورودی/خروجی پنل‌ها */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .panel-enter {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* انیمیشن موشن‌گرافیک برای آمار پروفایل */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stat-item {
            animation: slideInUp 0.5s ease-out;
        }
        
        .stat-item:nth-child(1) { animation-delay: 0.1s; }
        .stat-item:nth-child(2) { animation-delay: 0.2s; }
        .stat-item:nth-child(3) { animation-delay: 0.3s; }
        .stat-item:nth-child(4) { animation-delay: 0.4s; }
        .stat-item:nth-child(5) { animation-delay: 0.5s; }
    </style>
</head>
<body class="bg-[#0A0A0A] flex items-center justify-center min-h-screen p-4">

<div id="app" class="w-full max-w-sm mx-auto flex flex-col items-center main-menu-bg"></div>

<script>
    // Game data and state management
    const gameData = {
        // افزودن آمار بازی آنلاین به شیء کاربر
        user: { name: '', age: 0, cups: 0, onlineWins: 0, onlineLosses: 0, totalBans: 0 },
        botNames: ["فاطمه حسینی", "مهتاب جلالی", "Alixc", "a_p_12", "Aria_P24", "MinaK", "Laleh98", "نیما رحیمی", "نرگس راد", "RoyaG"],
        // افزودن آمار ساختگی برای ربات
        bot: { name: '', cups: 0, onlineWins: Math.floor(Math.random() * 50), onlineLosses: Math.floor(Math.random() * 20) },
        topics: ["سینما", "اطلاعات عمومی", "تاریخ و جغرافیا", "موسیقی و فرهنگ", "علمی و تکنولوژی"],
        questions: {
            "سینما": [
                { q: "فیلم 'جدایی نادر از سیمین' برنده چه جایزه‌ای شد؟", a: "اسکار", options: ["نخل طلا", "اسکار", "گلدن گلوب", "بافتا"] },
                { q: "کارگردان سه‌گانه 'پدرخوانده' کیست؟", a: "فرانسیس فورد کاپولا", options: ["مارتین اسکورسیزی", "استنلی کوبریک", "فرانسیس فورد کاپولا", "استیون اسپیلبرگ"] },
                { q: "کدام بازیگر به عنوان 'مرلین مونرو' سینمای ایران شناخته می‌شود؟", a: "فروزان", options: ["فروزان", "گوگوش", "لیلا فروهر", "سوسن"] },
                { q: "بازیگر نقش اصلی فیلم 'پاپیون' کیست؟", a: "استیو مک‌کوئین", options: ["آل پاچینو", "استیو مک‌کوئین", "داستین هافمن", "ژان گابن"] },
            ],
            "اطلاعات عمومی": [
                { q: "کوچک‌ترین کشور جهان کدام است؟", a: "واتیکان", options: ["واتیکان", "موناکو", "سن مارینو", "نائورو"] },
                { q: "نام واحد پول ژاپن چیست؟", a: "ین", options: ["وون", "ین", "یوآن", "بات"] },
                { q: "نام تنها قاره‌ای که هیچ رودخانه‌ای ندارد چیست؟", a: "قطب جنوب", options: ["آفریقا", "استرالیا", "قطب جنوب", "اروپا"] },
                { q: "کدام حیوان در شب قادر به دیدن در تاریکی مطلق است؟", a: "هیچ حیوانی", options: ["جغد", "گربه", "هیچ حیوانی", "خفاش"] },
            ],
            "تاریخ و جغرافیا": [
                { q: "کدام کشور در آمریکای جنوبی قرار ندارد؟", a: "پرتغال", options: ["پرتغال", "برزیل", "شیلی", "آرژانتین"] },
                { q: "مهمترین بنای تاریخی شهر رم کدام است؟", a: "کولوسئوم", options: ["پانتئون", "کولوسئوم", "برج پیزا", "فروم روم"] },
                { q: "مخترع لامپ کیست؟", a: "توماس ادیسون", options: ["نیکولا تسلا", "توماس ادیسون", "الکساندر گراهام بل", "مایکل فارادی"] },
                { q: "نام طولانی‌ترین رودخانه در جهان چیست؟", a: "نیل", options: ["آمازون", "نیل", "یانگ‌تسه", "میسیسیپی"] },
            ],
            "موسیقی و فرهنگ": [
                { q: "کدام ساز از خانواده سازهای بادی برنجی است؟", a: "ترومپت", options: ["فلوت", "کلارینت", "ترومپت", "ویولن"] },
                { q: "نام نقاش مشهور 'مونالیزا' چیست؟", a: "لئوناردو داوینچی", options: ["ونسان ون‌گوگ", "لئوناردو داوینچی", "پابلو پیکاسو", "رافائل"] },
                { q: "نام مشهورترین اثر ویلیام شکسپیر چیست؟", a: "هملت", options: ["اتللو", "مکبث", "هملت", "رومئو و ژولیت"] },
                { q: "نام کامل شاعر بزرگ ایرانی، حافظ، چیست؟", a: "خواجه شمس‌الدین محمد", options: ["ابوالقاسم فردوسی", "جلال‌الدین محمد بلخی", "خواجه شمس‌الدین محمد", "سعدی"] },
            ],
            "علمی و تکنولوژی": [
                { q: "نام عنصری که عدد اتمی آن ۷۹ است چیست؟", a: "طلا", options: ["نقره", "طلا", "پلاتین", "مس"] },
                { q: "کدام سیاره به عنوان 'سیاره سرخ' شناخته می‌شود؟", a: "مریخ", options: ["مریخ", "ناهید", "مشتری", "عطارد"] },
                { q: "چه چیزی در اطراف خورشید می‌گردد؟", a: "زمین", options: ["ماه", "ستاره دنباله‌دار", "زمین", "شهاب‌سنگ"] },
                { q: "کوچک‌ترین واحد سازنده ماده چیست؟", a: "اتم", options: ["مولکول", "اتم", "کوارک", "پروتون"] },
            ]
        },
        game: {
            screen: 'onboarding',
            isOnlineMode: false,
            currentRound: 0,
            playerScore: 0,
            botScore: 0,
            totalQuestions: 0,
            playerCorrect: 0,
            botCorrect: 0,
            currentQuestionIndex: 0,
            currentTopic: '',
            questionInterval: null,
            roundTimer: null,
            intervalTimer: null,
        }
    };
    
    // Ban constants and logic
    const BAN_DURATION_MS = 60 * 1000; // 1 دقیقه در میلی‌ثانیه
    const BAN_KEY = 'onlineBanTimestamp';

    function getRemainingBanTime() {
        const banTimestamp = localStorage.getItem(BAN_KEY);
        if (!banTimestamp) {
            return 0;
        }
        const elapsedTime = Date.now() - parseInt(banTimestamp);
        return Math.max(0, BAN_DURATION_MS - elapsedTime);
    }

    // Modal to replace alert()
    function renderModal(message, withButton = true, callback = null) {
        const modalId = 'dynamic-modal';
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }

        const modalDiv = document.createElement('div');
        modalDiv.id = modalId;
        modalDiv.className = 'modal';

        let buttonHtml = '';
        if (withButton) {
            buttonHtml = `<button id="modal-close" class="button golden-gradient text-gray-900 mt-6 w-full">باشه</button>`;
        }

        modalDiv.innerHTML = `
            <div class="modal-content golden-glow">
                <p class="text-white text-lg">${message}</p>
                ${buttonHtml}
            </div>
        `;
        document.body.appendChild(modalDiv);

        if (withButton) {
            document.getElementById('modal-close').addEventListener('click', () => {
                modalDiv.remove();
                if (callback) callback();
            });
        }
    }

    // Function to show profile modal
    function renderProfileModal() {
        renderModal(`
            <div class="flex flex-col items-center">
                <h2 class="text-3xl font-bold text-golden mb-4">پروفایل کاربری</h2>
                <div class="profile-card-content w-full flex flex-col space-y-4 text-left">
                    <div class="flex justify-between items-center stat-item">
                        <span class="text-gray-400">نام:</span>
                        <span class="text-white font-bold">${gameData.user.name}</span>
                    </div>
                    <div class="flex justify-between items-center stat-item">
                        <span class="text-gray-400">سن:</span>
                        <span class="text-white font-bold">${gameData.user.age}</span>
                    </div>
                    <div class="flex justify-between items-center stat-item">
                        <span class="text-gray-400">کاپ‌ها:</span>
                        <span class="text-golden font-bold">${gameData.user.cups}</span>
                    </div>
                    <hr class="border-gray-700">
                    <div class="flex justify-between items-center stat-item">
                        <span class="text-gray-400">تعداد برد آنلاین:</span>
                        <span class="text-green-400 font-bold">${gameData.user.onlineWins}</span>
                    </div>
                    <div class="flex justify-between items-center stat-item">
                        <span class="text-gray-400">تعداد باخت آنلاین:</span>
                        <span class="text-red-400 font-bold">${gameData.user.onlineLosses}</span>
                    </div>
                    <div class="flex justify-between items-center stat-item">
                        <span class="text-gray-400">دفعات بن شدن:</span>
                        <span class="text-red-500 font-bold">${gameData.user.totalBans}</span>
                    </div>
                </div>
            </div>
        `);
    }

    // The main render function
    function renderScreen() {
        const app = document.getElementById('app');
        app.classList.remove('panel-enter');
        void app.offsetWidth; // Force reflow to restart animation
        app.innerHTML = '';
        switch (gameData.game.screen) {
            case 'onboarding':
                renderOnboarding();
                break;
            case 'mainMenu':
                renderMainMenu();
                break;
            case 'onlineSearching':
                renderOnlineSearching();
                break;
            case 'game':
                renderGame();
                break;
            case 'endGame':
                renderEndGame();
                break;
            case 'settings':
                renderSettings();
                break;
            case 'navbarPlaceholder':
                renderPlaceholder();
                break;
            case 'banPanel':
                renderBanPanel();
                break;
        }
        app.classList.add('panel-enter');
    }

    // Onboarding screen
    function renderOnboarding() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="card w-full p-6 space-y-6 bg-[#1a1a1a] rounded-xl golden-glow">
                <h1 class="text-3xl font-bold text-center text-golden">ورود</h1>
                <div class="flex flex-col space-y-4">
                    <input id="username" type="text" placeholder="نام کاربری" class="p-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-golden">
                    <input id="age" type="number" placeholder="سن" class="p-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-golden">
                </div>
                <label class="flex items-center space-x-2 space-x-reverse text-sm cursor-pointer">
                    <input type="checkbox" id="agree" class="h-4 w-4 rounded text-golden-glow focus:ring-golden">
                    <span class="text-gray-400">با تمامی قوانین موافقم.</span>
                </label>
                <button id="onboarding-continue" class="button w-full golden-gradient text-gray-900 font-bold">
                    ادامه
                </button>
            </div>
        `;
        document.getElementById('onboarding-continue').addEventListener('click', () => {
            const username = document.getElementById('username').value.trim();
            const age = parseInt(document.getElementById('age').value);
            const agree = document.getElementById('agree').checked;

            if (username && age && agree) {
                gameData.user.name = username;
                gameData.user.age = age;
                gameData.game.screen = 'mainMenu';
                renderScreen();
            } else {
                renderModal('لطفاً تمامی فیلدها را پر کنید و با قوانین موافقت نمایید.');
            }
        });
    }

    // Main menu screen
    function renderMainMenu() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="w-full h-screen flex flex-col items-center justify-between main-menu-bg">
                <!-- Top Bar -->
                <div class="fixed top-0 left-0 right-0 z-50 flex justify-between items-center px-4 py-4">
                    <div id="settings-btn" class="p-2 cursor-pointer transition-transform duration-200 hover:rotate-45">
                        <svg class="h-8 w-8 text-golden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.525.265 1.127.398 1.729.398h.001z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div id="user-profile-btn" class="flex items-center space-x-2 space-x-reverse profile-card">
                        <div class="flex flex-col items-end">
                            <span class="text-sm font-bold text-gray-200">${gameData.user.name}</span>
                            <span class="text-xs text-golden">${gameData.user.cups} کاپ</span>
                        </div>
                        <svg class="h-8 w-8 text-golden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A7.962 7.962 0 0112 15c2.446 0 4.717.966 6.439 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                </div>

                <!-- Main Buttons -->
                <div class="flex flex-col space-y-6 w-full items-center mt-48">
                    <button id="online-btn" class="button w-3/4 text-xl bg-[#2e2e2e] text-golden golden-glow">
                        بازی آنلاین
                    </button>
                    <button id="start-btn" class="button w-3/4 text-xl golden-gradient text-gray-900 golden-glow">
                        شروع بازی
                    </button>
                </div>
                
                <!-- Spacer for layout -->
                <div class="h-48"></div>

                <!-- Bottom Navbar -->
                <div class="fixed bottom-0 right-0 w-full flex justify-around bg-[#1a1a1a] rounded-t-2xl p-4 golden-glow">
                    <div id="store-btn" class="flex flex-col items-center cursor-pointer">
                        <svg class="w-6 h-6 text-golden navbar-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.183 1.727.707 1.727H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span class="text-xs mt-1 text-gray-400">فروشگاه</span>
                    </div>
                    <div id="challenges-btn" class="flex flex-col items-center cursor-pointer">
                        <svg class="w-6 h-6 text-golden navbar-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M10 16h.01" />
                        </svg>
                        <span class="text-xs mt-1 text-gray-400">چالش‌ها</span>
                    </div>
                    <div id="history-btn" class="flex flex-col items-center cursor-pointer">
                        <svg class="w-6 h-6 text-golden navbar-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-xs mt-1 text-gray-400">تاریخچه</span>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('user-profile-btn').addEventListener('click', renderProfileModal);
        document.getElementById('settings-btn').addEventListener('click', () => {
            gameData.game.screen = 'settings';
            renderScreen();
        });
        document.getElementById('start-btn').addEventListener('click', () => {
            gameData.game.isOnlineMode = false;
            gameData.game.screen = 'game';
            resetGame();
            renderScreen();
        });
        document.getElementById('online-btn').addEventListener('click', () => {
            const remainingBanTime = getRemainingBanTime();
            if (remainingBanTime > 0) {
                gameData.game.screen = 'banPanel';
                renderScreen();
            } else {
                gameData.game.isOnlineMode = true;
                gameData.game.screen = 'onlineSearching';
                renderScreen();
            }
        });
        document.getElementById('store-btn').addEventListener('click', () => {
            renderModal('این صفحه هنوز پیاده‌سازی نشده است.');
        });
        document.getElementById('challenges-btn').addEventListener('click', () => {
            renderModal('این صفحه هنوز پیاده‌سازی نشده است.');
        });
        document.getElementById('history-btn').addEventListener('click', () => {
            renderModal('این صفحه هنوز پیاده‌سازی نشده است.');
        });
    }

    // Searching for online opponent screen
    function renderOnlineSearching() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full space-y-8">
                <svg class="h-24 w-24 text-golden magnifying-glass-animated" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <p class="text-lg text-gray-400">در حال جستجوی حریف...</p>
            </div>
        `;
        setTimeout(() => {
            gameData.game.screen = 'game';
            resetGame();
            const randomBotName = gameData.botNames[Math.floor(Math.random() * gameData.botNames.length)];
            gameData.bot.name = randomBotName;
            gameData.bot.cups = Math.floor(Math.random() * 1000);
            renderScreen();
        }, 3000);
    }

    // Game screen with new UI
    function renderGame() {
        const app = document.getElementById('app');
        const topic = gameData.topics[gameData.game.currentRound];
        const question = gameData.game.currentQuestion;
        app.innerHTML = `
            <div class="w-full h-screen flex flex-col justify-between">
                <!-- Top Bar with Player and Opponent Avatars -->
                <div class="flex justify-between items-center w-full p-4 mb-4">
                    <!-- Bot/Opponent Profile (Left) -->
                    <div class="flex items-center space-x-2 profile-card">
                        <svg class="h-8 w-8 text-golden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A7.962 7.962 0 0112 15c2.446 0 4.717.966 6.439 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <div class="flex flex-col items-start">
                            <span class="text-sm font-bold text-gray-200">${gameData.game.isOnlineMode ? gameData.bot.name : 'ربات'}</span>
                            <span class="text-xs text-golden">${gameData.game.isOnlineMode ? gameData.bot.cups + ' کاپ' : 'حالت آفلاین'}</span>
                        </div>
                    </div>

                    <!-- Timer and Score -->
                    <div class="flex flex-col items-center space-y-2">
                        <span class="text-2xl font-bold text-white countdown-text" id="round-timer">۴۰</span>
                        <div class="flex space-x-4 space-x-reverse text-sm font-bold">
                            <span class="text-green-400">شما: ${gameData.game.playerCorrect}</span>
                            <span class="text-red-400">حریف: ${gameData.game.botCorrect}</span>
                        </div>
                    </div>

                    <!-- User Profile (Right) -->
                    <div id="user-profile-game-btn" class="flex items-center space-x-2 space-x-reverse profile-card">
                        <div class="flex flex-col items-end">
                            <span class="text-sm font-bold text-gray-200">${gameData.user.name}</span>
                            <span class="text-xs text-golden">${gameData.user.cups} کاپ</span>
                        </div>
                        <svg class="h-8 w-8 text-golden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A7.962 7.962 0 0112 15c2.446 0 4.717.966 6.439 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                </div>

                <!-- Game Content and Question Card -->
                <div class="flex flex-col items-center flex-grow justify-center w-full px-4">
                    <!-- Question Card -->
                    <div id="question-card" class="card w-full flex flex-col items-center p-6 golden-glow bg-[#1a1a1a] rounded-xl" style="display:none;">
                        <span class="text-sm text-gray-400 mb-2">موضوع: ${topic} | راند ${gameData.game.currentRound + 1} از ۳</span>
                        <p id="question-text" class="text-center text-xl font-semibold mb-6">${question ? question.q : ''}</p>
                        
                        <!-- Options Grid -->
                        <div class="grid grid-cols-2 gap-4 w-full">
                            ${question ? question.options.map((opt, i) => `
                                <button class="option-btn button bg-[#2e2e2e] text-white" data-answer="${opt}">
                                    ${opt}
                                </button>
                            `).join('') : ''}
                        </div>
                    </div>

                    <!-- Round Intro -->
                    <div id="round-intro" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-80 z-20 transition-opacity duration-500">
                        <h2 class="text-2xl font-bold text-white mb-4">موضوع: ${topic}</h2>
                        <p class="text-lg text-gray-400">شروع بازی در...</p>
                        <p id="interval-countdown" class="text-5xl text-golden font-bold mt-2 countdown-text">۳</p>
                    </div>
                </div>
            </div>

            <!-- Back Button and Exit Modal -->
            <button id="back-btn" class="absolute top-4 left-4 p-2 cursor-pointer z-50 transition-transform duration-200 hover:scale-110">
                <svg class="h-8 w-8 text-golden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>
        `;
        document.querySelectorAll('.option-btn').forEach(button => {
            button.addEventListener('click', handleAnswer);
        });
        document.getElementById('back-btn').addEventListener('click', handleGameExit);
        document.getElementById('user-profile-game-btn').addEventListener('click', renderProfileModal);

        startRoundInterval();
    }
    
    // End game screen
    function renderEndGame() {
        const app = document.getElementById('app');
        const winnerText = gameData.game.isOnlineMode
            ? (gameData.game.playerCorrect > gameData.game.botCorrect ? 'شما برنده شدید!' : (gameData.game.playerCorrect < gameData.game.botCorrect ? 'حریف برنده شد.' : 'بازی مساوی شد.'))
            : 'بازی به پایان رسید.';

        app.innerHTML = `
            <div class="card w-full p-6 space-y-6 text-center golden-glow bg-[#1a1a1a] rounded-xl">
                <h2 class="text-2xl font-bold text-golden">${winnerText}</h2>
                ${gameData.game.isOnlineMode ? `
                <div class="flex justify-between w-full font-bold text-lg">
                    <span>شما</span>
                    <span>${gameData.game.playerCorrect} درست</span>
                </div>
                <div class="flex justify-between w-full font-bold text-lg">
                    <span>${gameData.bot.name}</span>
                    <span>${gameData.game.botCorrect} درست</span>
                </div>` : `
                <div class="flex justify-between w-full font-bold text-lg">
                    <span>تعداد پاسخ‌های درست:</span>
                    <span>${gameData.game.playerCorrect}</span>
                </div>
                `}
                <div class="flex flex-col space-y-4 mt-6">
                    <button id="return-to-menu-btn" class="button w-full bg-[#2e2e2e] text-golden">
                        بازگشت به منو
                    </button>
                    <button id="review-questions-btn" class="button w-full bg-[#2e2e2e] text-golden">
                        مرور سوال‌ها
                    </button>
                    <button id="share-btn" class="button w-full golden-gradient text-gray-900">
                        اشتراک‌گذاری
                    </button>
                </div>
            </div>
        `;

        document.getElementById('return-to-menu-btn').addEventListener('click', () => {
            gameData.game.screen = 'mainMenu';
            renderScreen();
        });
        document.getElementById('review-questions-btn').addEventListener('click', () => {
            renderModal('این قابلیت هنوز پیاده‌سازی نشده است.');
        });
        document.getElementById('share-btn').addEventListener('click', () => {
            renderModal('این قابلیت هنوز پیاده‌سازی نشده است.');
        });
    }

    // Settings screen
    function renderSettings() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="card w-full p-6 space-y-4 bg-[#1a1a1a] rounded-xl golden-glow">
                <h2 class="text-2xl font-bold text-golden text-center">تنظیمات</h2>
                <div class="space-y-3">
                    <p class="card p-3 bg-gray-800 rounded-lg">کد هدیه: این بخش به زودی فعال می‌شود.</p>
                    <p class="card p-3 bg-gray-800 rounded-lg">سازندگان: تیم توسعه در حال کار روی بهبود بازی است.</p>
                    <p class="card p-3 bg-gray-800 rounded-lg">پشتیبانی: برای هرگونه سوال یا مشکل با ما در ارتباط باشید.</p>
                </div>
                <button id="back-to-menu-btn" class="button w-full golden-gradient text-gray-900 mt-6">
                    بازگشت
                </button>
            </div>
        `;
        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            gameData.game.screen = 'mainMenu';
            renderScreen();
        });
    }

    // Placeholder screen for navbar items
    function renderPlaceholder() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="card w-full p-6 space-y-4 text-center bg-[#1a1a1a] rounded-xl golden-glow">
                <h2 class="text-2xl font-bold text-golden">این صفحه در دست ساخت است!</h2>
                <p class="text-gray-400">به زودی ویژگی‌های جدیدی به بازی اضافه می‌شود.</p>
                <button id="back-to-menu-btn" class="button w-full golden-gradient text-gray-900 mt-6">
                    بازگشت به منو
                </button>
            </div>
        `;
        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            gameData.game.screen = 'mainMenu';
            renderScreen();
        });
    }
    
    let banCountdownInterval;

    function renderBanPanel() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="card w-full p-6 space-y-4 text-center golden-glow panel-enter bg-[#1a1a1a] rounded-xl">
                <h2 class="text-2xl font-bold text-golden">اکانت شما مسدود است</h2>
                <p class="text-gray-400">
                    به علت ترک بازی آنلاین، اکانت شما به مدت یک دقیقه مسدود شده است.
                </p>
                <div class="flex flex-col items-center">
                    <span class="text-sm text-gray-500">زمان باقی‌مانده:</span>
                    <span id="ban-countdown" class="text-4xl font-bold text-red-500 countdown-text mt-2">--:--</span>
                </div>
                <p class="text-gray-400">تا زمان رفع مسدودی می‌توانید بازی تک نفره انجام دهید.</p>
                <button id="back-to-menu-btn" class="button w-full golden-gradient text-gray-900 mt-6">
                    بازگشت به منو
                </button>
            </div>
        `;
        
        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            clearInterval(banCountdownInterval);
            gameData.game.screen = 'mainMenu';
            renderScreen();
        });

        const countdownElement = document.getElementById('ban-countdown');
        if (!countdownElement) return;

        clearInterval(banCountdownInterval);
        
        function updateCountdown() {
            const remainingTime = getRemainingBanTime();
            if (remainingTime <= 0) {
                clearInterval(banCountdownInterval);
                renderModal('مسدودیت اکانت شما برطرف شد!', true, () => {
                    gameData.game.screen = 'mainMenu';
                    renderScreen();
                });
                return;
            }
            
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            countdownElement.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        updateCountdown();
        banCountdownInterval = setInterval(updateCountdown, 1000);
    }

    // Game logic functions
    function resetGame() {
        gameData.game.playerScore = 0;
        gameData.game.botScore = 0;
        gameData.game.currentRound = 0;
        gameData.game.playerCorrect = 0;
        gameData.game.botCorrect = 0;
        gameData.game.currentQuestionIndex = 0;
        if (gameData.game.roundTimer) clearInterval(gameData.game.roundTimer);
        if (gameData.game.intervalTimer) clearInterval(gameData.game.intervalTimer);
    }

    function startRoundInterval() {
        const introScreen = document.getElementById('round-intro');
        const countdownElement = document.getElementById('interval-countdown');
        let count = 3;
        introScreen.style.display = 'flex';
        countdownElement.innerText = count;

        gameData.game.intervalTimer = setInterval(() => {
            count--;
            countdownElement.innerText = count;
            if (count <= 0) {
                clearInterval(gameData.game.intervalTimer);
                introScreen.style.display = 'none';
                startGameRound();
            }
        }, 1000);
    }

    function startGameRound() {
        gameData.game.currentQuestionIndex = 0;
        let timeRemaining = 40;
        const timerElement = document.getElementById('round-timer');
        const questionCard = document.getElementById('question-card');
        questionCard.style.display = 'flex';

        timerElement.innerText = timeRemaining;
        gameData.game.roundTimer = setInterval(() => {
            timeRemaining--;
            timerElement.innerText = timeRemaining;
            if (timeRemaining <= 0) {
                clearInterval(gameData.game.roundTimer);
                endGameRound();
            }
        }, 1000);

        displayNextQuestion();
    }

    function displayNextQuestion() {
        const topic = gameData.topics[gameData.game.currentRound];
        const questionsForTopic = gameData.questions[topic];

        if (gameData.game.currentQuestionIndex >= questionsForTopic.length) {
            endGameRound();
            return;
        }

        const question = questionsForTopic[gameData.game.currentQuestionIndex];
        gameData.game.currentTopic = topic;
        gameData.game.currentQuestion = question;
        gameData.game.currentQuestionIndex++;

        // Update UI with new question
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.querySelector('#question-card .grid');

        if (questionTextElement && optionsContainer) {
            questionTextElement.innerText = question.q;
            optionsContainer.innerHTML = question.options.map((opt, i) => `
                <button class="option-btn button bg-[#2e2e2e] text-white" data-answer="${opt}">
                    ${opt}
                </button>
            `).join('');
            document.querySelectorAll('.option-btn').forEach(button => {
                button.addEventListener('click', handleAnswer);
            });
        }

        if (gameData.game.isOnlineMode) {
            botAnswer();
        }
    }

    function handleAnswer(event) {
        // Disable all buttons to prevent multiple clicks
        document.querySelectorAll('.option-btn').forEach(button => button.disabled = true);

        const selectedAnswer = event.target.dataset.answer;
        const isCorrect = selectedAnswer === gameData.game.currentQuestion.a;

        if (isCorrect) {
            gameData.game.playerCorrect++;
            event.target.classList.add('bg-green-600', 'golden-glow');
        } else {
            event.target.classList.add('bg-red-600');
            // Highlight the correct answer
            const correctBtn = document.querySelector(`.option-btn[data-answer="${gameData.game.currentQuestion.a}"]`);
            if (correctBtn) {
                correctBtn.classList.add('bg-green-600', 'golden-glow');
            }
        }
        
        document.querySelector('#round-timer').classList.remove('text-white');
        document.querySelector('#round-timer').classList.add(isCorrect ? 'text-green-500' : 'text-red-500');

        setTimeout(() => {
            document.querySelector('#round-timer').classList.remove('text-green-500', 'text-red-500');
            document.querySelector('#round-timer').classList.add('text-white');
            displayNextQuestion();
        }, 1500);
    }
    
    function botAnswer() {
        const isBotCorrect = Math.random() < 0.7; // 70% chance of bot being correct
        if (isBotCorrect) {
            gameData.game.botCorrect++;
        }
        const botScoreDisplay = document.getElementById('bot-score-display');
        if (botScoreDisplay) {
            botScoreDisplay.innerText = gameData.game.botCorrect;
        }
    }

    function endGameRound() {
        clearInterval(gameData.game.roundTimer);
        gameData.game.currentRound++;
        if (gameData.game.currentRound < gameData.topics.length) {
            renderScreen();
        } else {
            // Check if game was online to update stats
            if (gameData.game.isOnlineMode) {
                updateOnlineStats();
            }
            gameData.game.screen = 'endGame';
            renderScreen();
        }
    }

    function handleGameExit() {
        if (gameData.game.isOnlineMode) {
            renderModal('آیا مطمئن هستید که می‌خواهید بازی را ترک کنید؟ با خروج، یک باخت برای شما ثبت می‌شود.', true, () => {
                gameData.user.onlineLosses++;
                gameData.user.totalBans++;
                localStorage.setItem(BAN_KEY, Date.now().toString());
                gameData.game.screen = 'mainMenu';
                renderScreen();
            });
        } else {
            gameData.game.screen = 'mainMenu';
            renderScreen();
        }
    }

    function updateOnlineStats() {
        if (gameData.game.playerCorrect > gameData.game.botCorrect) {
            gameData.user.onlineWins++;
        } else if (gameData.game.playerCorrect < gameData.game.botCorrect) {
            gameData.user.onlineLosses++;
        }
    }

    // Initial render
    renderScreen();
</script>
</body>
</html>
